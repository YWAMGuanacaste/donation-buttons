<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Donation Site</title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/skeleton.css">

    <script src="https://www.gstatic.com/firebasejs/5.3.1/firebase.js"></script>

    <script src="js/config.js"></script>
    <script src="js/storageService.js"></script>
</head>

<body>
  <h1>Donation page</h1>
  <p>
      This page visualizes donations for the following project:<br/>
      <span><b>Name:</b> Demo Project</span><br/>
      <span><b>Description:</b> This project is just a demo.</span>
  </p>


  <div id="container" style="position: relative">
      <img id="image" style="position: absolute">
	  <div id="buttons" style="position: absolute">
      </div>
  </div>

  <div style="margin-top: 1.5em">
      <h2>How this page works:</h2>
      <ol>
          <li>Every button represents an amount in USD ($) or EUR (â‚¬)</li>
          <li>Semi-Transparent numbers are already marked as done by some user, transparent spots are verified to be done.</li>
          <li>Click on a non-semi-transparent button if you want to donate a specific amount.</li>
          <li>You will be redirected to a page with payment information - please choose a payment method and do the donation.</li>
          <li>If you decide to not donate an amount you have already clicked on, please re-click the amount to unmark it.</li>
      </ol>
  </div>
  
  <script>
	  var btnMarginPx = 2;
	  var imageW, imageH, btnW, btnH;
	  document.getElementById("image").src = C.backgroundImage;
	  document.getElementById("image").onload = init;
	  
	  function init() {
		  imageW = getW(document.getElementById("image"));
		  imageH = getH(document.getElementById("image"));
		  btnW = (imageW - btnMarginPx) / C.elementsByRow;
		  btnH = (imageH - btnMarginPx) / Math.ceil((C.upperLimit-C.lowerLimit+1)/C.elementsByRow);
		  document.getElementById('container').style.height = imageH + 'px';

		  generateButtons();
          storageService.getClickedAmounts().then(function (clickedAmounts) {
              console.log('clicked got from cloud storage: ' + clickedAmounts);
              markButtons(clickedAmounts);
          });
          storageService.setUpdateHandler(function (clickedAmounts) {
              console.log('clicked got from cloud storage: ' + clickedAmounts);
              markButtons(clickedAmounts);
          })
	  }
	  
	  function getW(element) {
		  return element.getBoundingClientRect().width;
	  }
	  
	  function getH(element) {
		  return element.getBoundingClientRect().height;
	  }
	  
	  function buttonClicked(element) {
		  if(element.classList.contains('done')) return;
		  
		  
		  var isClicked = element.classList.contains('clicked');
		  
		  if(!isClicked) {
			  if(!confirm("Do you want to spend the amount of " + element.id + C.currency + "? Clicking on 'OK' will mark this amount as done and redirect you to a page with payment information.")) {
				  return;
			  }
			  element.classList.add('clicked');
              storageService.markAmount(parseInt(element.id));
              if(C.redirectOnClickURL) {
                  var delay = C.redirectDelayMs === parseInt(C.redirectDelayMs, 10) ? C.redirectDelayMs : 1000;
                  setTimeout(function () {
                      window.location.href = C.redirectOnClickURL;
                  }, delay);
              }
		  } else {
			  if(confirm("Do you really want to unmark the amount " + element.id + C.currency + "? Please only do this if you clicked on this button before and you now decided to not spend the money.")) {
				  element.classList.remove('clicked');
                  storageService.unmarkAmount(parseInt(element.id));
			  }
		  }
	  }
  
	  function generateButtons() {
		  var time = new Date().getTime();
		  var newHtml = '';
		  for (var i = C.lowerLimit; i<=C.upperLimit; i++) {
			 var buttonHtml = '<button id="' + i + '" onclick="buttonClicked(this)"><span>' + i + ' ' + C.currency + '</span></button>';
			 newHtml += buttonHtml;
			 if (i % C.elementsByRow == 0) newHtml += '</br>';
			 document.getElementById('buttons').innerHTML = newHtml;
		  }
		  
		  var wPx = (btnW -  2*btnMarginPx) + "px";
		  var hPx = (btnH -  2*btnMarginPx) + "px";
		  var fontPx = C.fontSize || ((btnH -  2*btnMarginPx)/2) + "px";
		  for (var i = C.lowerLimit; i<=C.upperLimit; i++) {
			 var newBtn = document.getElementById(i);
			 newBtn.style.width = wPx;
			 newBtn.style.height = hPx;
			 newBtn.style.fontSize = fontPx;
		  }
		  console.log("generation took: " + (new Date().getTime() - time) + "ms");
	  }

	  function markButtons(clickedAmounts) {
          for (var i = C.lowerLimit; i<=C.upperLimit; i++) {
              var btn = document.getElementById(i);
              if(C.doneAmounts.indexOf(i) !== -1) {
                  btn.classList.add('done');
              } else if (clickedAmounts.indexOf(i) !== -1) {
                  btn.classList.add('clicked');
              } else {
                  btn.classList.remove('clicked');
              }
          }
      }
	  
  </script>
</body>
</html>